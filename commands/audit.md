# Аудит кода (GATE 2)

Выполни проверку качества кода перед приёмкой.

## Шаг 0: Проверка миграций БД (если схема менялась)

Если при работе над текущей задачей менялась схема базы данных:

1. Проверь статус миграций (команду ищи в CLAUDE.md или package.json)
2. Все миграции applied -> OK, продолжать
3. Есть pending миграции -> **СТОП**: примени миграции
4. Проверь что файлы миграций созданы

**Без applied миграций пользователь НЕ МОЖЕТ тестировать. Это БЛОКЕР.**

Если БД-схема не менялась — пропусти этот шаг.

## Шаг 1: Обязательные проверки

Запусти проверки качества проекта. Найди команды в CLAUDE.md или package.json:

1. **Lint** — линтер (ESLint, Ruff, etc.)
2. **Type-check** — проверка типов (TypeScript, mypy, etc.)
3. **Build** — сборка проекта
4. **Test** — тесты

Все четыре должны пройти без ошибок. Если есть ошибки — покажи их и предложи исправления.

## Шаг 2: Stub detection и wiring check

Проверь все изменённые/созданные файлы на заглушки и связность:

**Stub detection** — поищи в изменённых файлах:
- `TODO`, `FIXME`, `XXX`, `HACK`, `PLACEHOLDER`
- `implement later`, `coming soon`, `add later`
- Пустые реализации: `return null`, `return {}`, `return []`, `pass`
- console.log-only обработчики (есть `console.log`, но нет реальной логики)
- Хардкод вместо конфигурации (захардкоженные URL, ключи, магические числа)

**Wiring check** — для каждого нового файла проверь:
- Импортируется ли он откуда-то? (не orphaned)
- Используется ли экспорт? (не dead code)
- Для компонентов: рендерится ли в layout/page?
- Для API routes: вызывается ли из клиентского кода?

Покажи результат:
```
Stubs:     [найдено N] / [чисто]
Wiring:    [N orphaned файлов] / [всё подключено]
```

**Если найдены stubs — БЛОКЕР, исправить до приёмки.**
**Если найдены orphaned файлы — предупредить владельца.**

## Шаг 3: Оценка необходимости полного аудита

Проверь, выполняется ли хотя бы одно условие:
- Новый код > 100 строк
- Изменения в API / auth / data layer
- Добавлены новые зависимости
- Изменены security-related файлы

Если ДА — запусти @auditor с контекстом:
```
@auditor Проверь изменения:
- [список изменённых файлов]
Режим: после разработки (до приёмки)
```

Если НЕТ — сообщи что минимальные проверки пройдены и полный аудит не требуется.

## Шаг 4: Отчёт

Покажи результат в формате:

```
## Результат аудита

Migrations: (applied) / (pending!) / (n/a)
Lint:       (pass) / (fail) [детали]
Type-check: (pass) / (fail) [детали]
Build:      (pass) / (fail) [детали]
Stubs:      (чисто) / (найдено N!)
Wiring:     (всё подключено) / (N orphaned!)

Полный аудит: [проведён / не требуется]

CRITICAL: [блокирует приёмку]
MAJOR:    [желательно исправить]
MINOR:    [исправлено автоматически]
```

Если есть CRITICAL — приёмка ЗАБЛОКИРОВАНА до исправления.
