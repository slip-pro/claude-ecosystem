---
name: done
description: Закрыть работу по задаче с доски. Итоги, приёмка, тесты, pre-commit проверки, коммит, обновление доски, документация, рефлексия.
argument-hint: "[card-id]"
allowed-tools: mcp__board__get_board_tasks, mcp__board__get_card_details, mcp__board__move_card, mcp__board__add_comment, mcp__board__update_card
---

# Закрытие работы по задаче

Выполни последовательность закрытия из DECISIONS.md.
Не пропускай ни одного шага. Если gate не пройден — остановись и сообщи.

## Шаг 1: Показать итоги (GATE 3 — Приёмка)

Вызови `get_board_tasks`, найди задачу в "In Progress" (или аналогичной колонке).
Если передан `$ARGUMENTS` — используй как ID карточки.
Вызови `get_card_details` для получения контекста.

### 1a. Goal-backward верификация (must_haves)

Перед показом итогов — проведи 3-уровневую проверку must-haves из плана задачи:

**Level 1 — Exists:** Все artifacts из плана существуют на диске.
**Level 2 — Substantive:** Файлы содержат реальную реализацию, а не заглушки.
Красные флаги: `TODO`, `FIXME`, `placeholder`, `implement later`, `return null`, `return {}`, `return []`, `console.log`-only handlers.
**Level 3 — Wired:** Ключевые связи (key_links) работают — файлы импортированы и используются, API вызываются, компоненты подключены.

Покажи результат верификации:

```
Must-haves верификация:

Truths:
[✓] [truth 1] — подтверждено
[✓] [truth 2] — подтверждено
[✗] [truth 3] — НЕ подтверждено: [причина]

Artifacts (exists → substantive → wired):
[✓✓✓] src/components/Chat.tsx — есть, 120 строк, импортирован в page.tsx
[✓✓✗] src/api/chat/route.ts — есть, реализован, НЕ вызывается из компонента
[✓✗-] src/utils/helper.ts — есть, но заглушка (return null)

Key Links:
[✓] Chat.tsx → /api/chat (fetch в useEffect)
[✗] page.tsx → Chat.tsx (компонент не импортирован)
```

**Если есть ✗ на Level 1-2 — СТОП, исправить до приёмки.**
**Если ✗ только на Level 3 (wiring) — показать владельцу, может быть ОК.**

### 1b. Spot-checks (автоматическая проверка на диске)

Не доверяй только памяти — проверь факты на диске:

1. **Файлы существуют** — для каждого ключевого файла из artifacts, проверь через Glob
2. **Коммиты есть** — `git log --oneline -10` содержит коммиты этой задачи
3. **Нет забытых TODO** — поищи `TODO`, `FIXME`, `HACK` в изменённых файлах
4. **Нет console.log** — поищи `console.log` в изменённых файлах (кроме тестов)
5. **Тесты не сломаны** — запусти тесты если есть, проверь exit code

Покажи результат:
```
Spot-checks:
[✓] Ключевые файлы на диске (N/N)
[✓] Коммиты присутствуют (N коммитов)
[✓] Нет забытых TODO/FIXME
[✓] Нет console.log
[✓] Тесты проходят
```

**Если spot-check провален — СТОП, исправить.**

### 1c. Итоги для владельца

Покажи владельцу:

```
Задача завершена: [название]

Must-haves: [N/N truths подтверждены, N/N artifacts verified]

Что сделано:
- [список изменений]

Проверка scope creep:
- Все изменения в рамках декомпозиции? (да/нет)

Сценарии тестирования:

### Сценарий 1: [название]
- URL: /path/to/page
- Шаги: ...
- Ожидаемый результат: ...

Файлы: [список созданных/изменённых]
```

**Жди явное "ОК" от владельца.** Без него дальше не двигайся.

## Шаг 2: Тесты (@tester)

После приёмки — запусти `@tester` для написания дополнительных тестов:

- Unit-тесты
- E2E-тесты для пользовательских сценариев
- Target: > 80% покрытие нового кода

**ВАЖНО**: Если в проекте применяется TDD, @developer уже написал тесты. @tester добавляет edge cases, integration, E2E.

После написания — запусти тесты (команду ищи в CLAUDE.md или package.json), убедись что всё проходит.

## Шаг 3: Pre-deploy проверки (GATE 4)

Запусти проверки качества проекта (команды ищи в CLAUDE.md или package.json):

1. **Lint** — MUST PASS
2. **Type-check** — MUST PASS
3. **Build** — MUST PASS
4. **Test** — MUST PASS

**Если хотя бы одна проверка не прошла — НЕ коммитить. Исправить и повторить.**

## Шаг 4: Commit

1. `git diff --stat` для понимания изменений
2. Сформируй осмысленное сообщение коммита
3. Исключи: `.env`, credentials, `.claude/settings.local.json`
4. Добавь Co-Authored-By
5. Создай коммит

## Шаг 5: Обновление карточки

1. `update_card` — добавить к описанию раздел с результатами (**формат HTML**):
   - Что сделано (кратко)
   - Ключевые файлы
   - Что проверить после деплоя
   - Пример: `<h2>Результат</h2><ul><li>...</li></ul>`
2. `add_comment` — итоговый комментарий с результатами
3. `move_card` — переместить в колонку для деплоя (название зависит от доски проекта)

## Шаг 6: Обновление документации (GATE 5 — ОБЯЗАТЕЛЬНО)

**Документация ДОЛЖНА быть обновлена в этой же сессии, а не отложена на потом.**

Покажи владельцу заполненный чек-лист. Адаптируй под проект (пути файлов ищи в CLAUDE.md):

```
Техническая документация:
□ Database docs     — схема БД обновлена? (да/нет/не применимо)
□ API docs          — API обновлён? (да/нет/не применимо)
□ Module docs       — документация модуля обновлена? (да/нет/не применимо)
□ @documentor       — нужна проверка консистентности? (да/нет)

Пользовательская документация (для UI изменений):
□ User docs         — обновлена? (да/нет/не применимо)
```

**Порядок действий:**
1. Показать чек-лист владельцу с ответами
2. **Немедленно обновить** все файлы, помеченные "да"
3. Коммит документации — в шаге 8

## Шаг 7: Рефлексия

Ответь на 5 вопросов и покажи владельцу:

1. Что нового узнали при работе над этой задачей?
2. Какие вопросы задавал владелец, которых нет в инструкциях?
3. Что было сложно / неочевидно?
4. Какие шаги workflow были нарушены и почему?
5. Что нужно добавить/изменить в инструкциях?

**Применить рефлексию** (обязательно):
- Обновить `CLAUDE.md` если обнаружены новые паттерны
- Обновить `DECISIONS.md` если обнаружены пробелы в процессе
- Обновить инструкции агентов если агент работал неоптимально

## Шаг 8: Финальный коммит документации

Если шаги 6-7 привели к изменениям — создай отдельный коммит для документации.

Подтверди владельцу: задача закрыта, ждёт деплоя.
