---
name: task
description: Открыть работу над задачей с доски. Выбор задачи, планирование с владельцем, настройка, старт разработки.
argument-hint: "[card-id]"
allowed-tools: mcp__board__get_board_tasks, mcp__board__get_card_details, mcp__board__move_card, mcp__board__add_comment, mcp__board__update_card
---

# Открытие работы над задачей

Выполни последовательность открытия работы — фаза 1 (Планирование, GATE 1) из DECISIONS.md.
Каждый шаг обязателен. Без подтверждения владельца дальше не двигайся.

## Шаг 0: Проверка предусловий

Вызови `get_board_tasks` и проверь:

1. **Нет ли задач в In Progress** — если есть, СТОП. Покажи:
   ```
   В работе: [название задачи]

   Варианты:
   A) Закрыть текущую задачу сначала (/done)
   B) Продолжить работу над текущей задачей
   C) Взять новую задачу параллельно (требует подтверждения)
   ```
   Жди решения владельца. Без явного выбора дальше не двигайся.

2. **Есть задачи в очереди** — колонки со статусом задач, готовых к взятию, не пусты.
   Если пусты — сообщи и предложи создать новую задачу.

## Шаг 1: Выбор задачи

**Если передан аргумент** (`$ARGUMENTS`) — это ID карточки, используй его. Перейди к шагу 2.

**Если аргумент не передан:**

Покажи задачи из колонок с готовыми к взятию задачами (названия колонок зависят от доски проекта):

```
Задачи, готовые к взятию:
1. [название] — [приоритет, исполнители]
2. ...

Какую задачу берём в работу?
```

**Жди явный выбор владельца.**

## Шаг 2: Получение деталей

Вызови `get_card_details` с ID выбранной карточки.
Покажи владельцу описание, чеклисты, комментарии — весь контекст задачи.

## Шаг 3: Совместное планирование (GATE 1)

1. Обсуди с владельцем **критерии готовности** — что значит "сделано"
2. Обсуди **подход** — как реализовать
3. **Согласуй декомпозицию** — разбей на подзадачи вместе с владельцем

**ВАЖНО**: Декомпозиция требует согласия владельца! Не разбивай самостоятельно.

Покажи итоговый план:

```
Задача: [название]

Must-haves (что должно быть TRUE после выполнения):
  Truths (наблюдаемое поведение):
  - [пользователь может ...]
  - [система делает ...]

  Artifacts (ключевые файлы):
  - [path/to/file.ts] — [что содержит]

  Key Links (связи):
  - [Component.tsx] → [/api/endpoint] через [fetch/import]

Декомпозиция:
- [ ] [подзадача 1] — [описание]
- [ ] [подзадача 2] — [описание]
- [ ] [подзадача 3] — [описание]

Подход: [краткое описание]
```

**Must-haves** — это контракт. Truths формулируй от пользователя/системы,
не от реализации. "Пользователь видит список сообщений", а не "Создать компонент MessageList".

**Жди явное "ОК" или корректировки от владельца.**
Без подтверждения декомпозиции и must-haves дальше не двигайся — это GATE 1.

## Шаг 4: Настройка

После получения "ОК" от владельца:

1. **Переместить карточку** — `move_card` в колонку "In Progress" (или аналог на доске проекта)
2. **Добавить комментарий** — `add_comment`: "Взято в работу"
3. **Обновить описание** — `update_card`: добавить к описанию раздел с планом реализации (**формат HTML**, пример: `<h2>План реализации</h2><ol><li>...</li></ol>`)

## Шаг 5: Выбор режима выполнения

Предложи владельцу режим выполнения:

```
Начинаю работу над: [название задачи]

Режим выполнения:
A) Обычный — выполняю подзадачи последовательно в текущем контексте
B) Субагентный — каждая подзадача в свежем контексте (лучше для больших задач)

Рекомендация: [A для 1-3 подзадач, B для 4+ подзадач или сложных задач]
```

### Режим A: Обычный

Переходи к фазе 2 (Разработка по DECISIONS.md) — выполняй подзадачи последовательно.

### Режим B: Субагентный (fresh context execution)

Выполняй роль **оркестратора** — не пиши код сам, делегируй субагентам:

1. **Для каждой подзадачи** запусти `Task(subagent_type="developer")`:
   - Передай путь к CLAUDE.md, описание подзадачи, must-haves
   - Субагент получает свежие 200k токенов контекста
   - Субагент пишет код и коммитит

2. **После каждого субагента** — spot-check:
   - Файлы существуют на диске?
   - Коммит создан?
   - Нет заглушек?

3. **Если подзадачи независимы** — запускай параллельно (несколько Task в одном сообщении)

4. **Если подзадача зависит от предыдущей** — запускай последовательно

Промпт для субагента:
```
Ты выполняешь подзадачу: [название]

Контекст проекта: прочитай CLAUDE.md
Must-haves для этой подзадачи:
- [truth / artifact / key_link]

Что сделать:
- [конкретные шаги]

После выполнения — создай коммит с описанием.
```

**Жди "ОК" от владельца.** После подтверждения — начинай выполнение.
