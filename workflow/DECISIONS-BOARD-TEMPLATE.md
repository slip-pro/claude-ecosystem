# AI Decision Framework

Инструкции для автономной работы над проектом [PROJECT].
Адаптируй: замени [PROJECT], добавь стеко-специфичные команды и паттерны.

---

## Философия

### Task-Driven
Владелец даёт задачи. AI реализует их по workflow ниже.
- Задача = измеримый результат для пользователя
- Фича = способ достижения задачи
- Подзадача = шаг реализации

### One Task at a Time
- Работаем над **ОДНОЙ** задачей пока не завершим
- Новые идеи добавляем на доску, не переключаемся
- Исключение: критические production-баги

### Autonomy with Boundaries
- AI принимает решения в рамках текущей задачи
- Выходы за рамки требуют подтверждения владельца

### Quality > Speed
- При проблеме: СТОП -> читаем правила -> планируем -> делаем правильно с первого раза
- Не торопимся

---

## Workflow

### Обязательные gates (КРИТИЧНО)

Gates — шаги, которые НЕЛЬЗЯ пропустить ни при каких обстоятельствах.
Агенты — инструмент. Gates обязательны независимо от того, кто выполняет работу.

```
GATE 1: ПЛАНИРОВАНИЕ    — согласовано с владельцем (задача + декомпозиция)
GATE 2: КАЧЕСТВО         — lint + type-check + build + test проходят (перед приёмкой)
GATE 3: ПРИЁМКА          — владелец видит итоги + сценарии и ЯВНО подтверждает
GATE 4: PRE-COMMIT       — lint + type-check + build + test (перед коммитом)
GATE 5: РЕФЛЕКСИЯ        — чек-лист закрытия пройден, документация обновлена
```

**Если gate не пройден — дальше двигаться НЕЛЬЗЯ.**

### Распознавание триггеров (КРИТИЧНО)

| Фраза пользователя | Что это значит | Что AI делает |
|---|---|---|
| "закрываем", "коммить", "готово", "финализируем" | Триггер **последовательности закрытия** | НЕ коммитить. Перейти к фазе 4 (Приёмка) |
| "ОК", "принято", "всё ок" (после итогов) | Приёмка пройдена | Перейти к Pre-commit -> Commit -> Рефлексия |
| "пуш", "push", "запушь" | Команда на push | Push (коммит уже должен быть создан) |

**ПРАВИЛО**: AI НИКОГДА не создаёт commit сразу после "закрываем".
Между "закрываем" и commit всегда: итоги -> сценарии -> приёмка -> pre-commit.

---

### 1. Планирование (совместно с владельцем)

**Команда**: `/task` — автоматизирует эту фазу (предусловия, выбор задачи, планирование, настройка).

**Что делаем вместе:**
1. Используем `get_board_tasks` для просмотра текущего состояния доски
2. Владелец выбирает задачу (или описывает новую)
3. Уточняем критерии готовности — что значит "сделано"
4. Обсуждаем подход — как реализовать
5. **Согласовываем декомпозицию** — разбиваем на подзадачи

**ВАЖНО**: Декомпозиция требует согласия владельца!
AI не должен самостоятельно разбивать задачу — делаем вместе.

**Результат**: Согласованный план и декомпозиция, старт автономной работы.

---

### 2. Разработка (@developer)

**Принципы:**
- Работаю последовательно по декомпозиции
- Следую существующим паттернам кодовой базы
- Решаю технические вопросы самостоятельно

**Когда НЕ спрашивать владельца:**
- Выбор библиотеки (если уже есть в проекте)
- Структура компонентов (следую существующим паттернам)
- Мелкие рефакторинги в рамках задачи
- Исправление lint/type ошибок

**Когда СПРАШИВАТЬ владельца:**
- Архитектурные решения (новый паттерн, новая зависимость)
- Изменение scope (нужно больше/меньше)
- Критический блокер (>2 часов без прогресса)
- Неоднозначные UX/UI решения
- Любые удаления/миграции данных

---

### 3. Аудит (GATE 2 — качество кода)

**Триггер**: Разработка завершена (перед приёмкой)

#### Минимальные проверки (ОБЯЗАТЕЛЬНЫ всегда):

<!-- Адаптируй команды под свой проект: npm run lint, npm run build, npm test, etc. -->

```bash
# Проверки качества — команды из CLAUDE.md или package.json
lint        # MUST PASS
type-check  # MUST PASS
build       # MUST PASS
test        # MUST PASS
```

**Если не проходит — НЕ переходить к приёмке. Исправить сначала.**

#### Полный аудит через @auditor (рекомендуется при):
- Новый код > 100 строк
- Изменения в API / auth / data layer
- Новые зависимости
- Security-related изменения

---

### 4. Приёмка (GATE 3 — владелец)

**Триггеры**:
- Аудит пройден (lint/type-check/build/test clean)
- Владелец сказал "закрываем" / "готово" / "финализируем"

**Обязательная последовательность**:
1. **Показать итоги** по шаблону (см. Шаблоны коммуникации)
2. **Проверка scope creep**: "Есть ли изменения НЕ из декомпозиции?"
3. **Тест-сценарии** — структурированные инструкции для проверки
4. **Ждать явного подтверждения** — "ОК" / "принято"
5. **Если ОК** -> тесты -> закрытие
6. **Если НЕ ОК** -> возврат к разработке

**ВАЖНО**: Приёмка по ЗАДАЧЕ, не по отдельным подзадачам.

---

### 5. Тесты (@tester)

**Триггер**: Приёмка пройдена

**Что @tester делает:**
- Unit-тесты
- E2E-тесты для пользовательских сценариев
- Target coverage: > 80%

---

### 6. Закрытие (GATE 4 + GATE 5)

**Команда**: `/done` — автоматизирует эту фазу (итоги, тесты, pre-commit, коммит, доска, документация, рефлексия).

**Шаги выполняются СТРОГО последовательно. Пропускать НЕЛЬЗЯ.**

#### 6a. Pre-commit проверки (GATE 4)

Запусти все проверки качества (команды из CLAUDE.md или package.json).
**Если хотя бы одна не прошла — НЕ коммитить. Исправить и повторить.**

#### 6b. Commit

- `git diff --stat` для понимания изменений
- Осмысленное сообщение коммита
- Исключить: .env, credentials, .claude/settings.local.json
- Добавить Co-Authored-By

#### 6c. Обновление карточки на доске

1. `update_card` — добавить раздел "Результат" с описанием
2. `add_comment` — итоговый комментарий
3. `move_card` — переместить в колонку для деплоя

#### 6d. Документация (GATE 5 — ОБЯЗАТЕЛЬНО)

**Документация ДОЛЖНА быть обновлена в этой же сессии, не "потом".**

Адаптируй чек-лист под проект (пути из CLAUDE.md):

```
□ Database docs     — схема БД обновлена? (да/нет/не применимо)
□ API docs          — API обновлён? (да/нет/не применимо)
□ Module docs       — документация модуля обновлена? (да/нет/не применимо)
□ User docs         — пользовательская документация? (да/нет/не применимо)
□ @documentor       — нужна проверка консистентности? (да/нет)
```

#### 6e. Рефлексия

5 обязательных вопросов:
1. Что нового узнали при работе над этой задачей?
2. Какие вопросы задавал владелец, которых нет в инструкциях?
3. Что было сложно / неочевидно?
4. Какие шаги workflow были нарушены и почему?
5. Что нужно добавить/изменить в инструкциях?

#### 6f. Применить рефлексию (ОБЯЗАТЕЛЬНО)

**Рефлексия без действий — бесполезна.** AI ОБЯЗАН сразу применить выводы:

1. **Обновить инструкции** — если обнаружены пробелы в DECISIONS.md, CLAUDE.md
2. **Обновить промпты агентов** — если агент работал неоптимально
3. **Обновить CLAUDE.md** — если обнаружены новые паттерны

#### 6g. Финальный коммит документации

Если шаги 6d-6f привели к изменениям — создать отдельный коммит для документации.

---

## Принятие решений

### Чек-лист: Нужно ли спрашивать?

```
Решение влияет только на текущую задачу?
  -> Нет: СПРАШИВАТЬ

Есть существующий паттерн в проекте?
  -> Да: Следовать паттерну, НЕ спрашивать

Решение обратимо за <30 минут?
  -> Да: Принять и двигаться дальше

Затрагивает деньги/безопасность/данные?
  -> Да: ОБЯЗАТЕЛЬНО СПРАШИВАТЬ

Не уверен?
  -> СПРАШИВАТЬ
```

### Чек-лист: Как обрабатывать блокер

```
1. Попробовал 2+ разных подхода?
2. Проверил документацию / issues?
3. Потратил >1 час на проблему?
4. Могу чётко сформулировать проблему?

Если все ДА -> Сообщить владельцу:
- Что пытался сделать
- Что попробовал
- Где застрял
- Какие варианты вижу

Если НЕ все ДА -> Продолжить попытки
```

### Чек-лист: Добавлять ли в scope

```
Фича НЕОБХОДИМА для критериев готовности?
  -> Да: Добавить в декомпозицию
  -> Нет: На доску как новую карточку

Это "nice to have"?
  -> Да: На доску, НЕ в текущий scope

Займёт >2 часов?
  -> Да: Обсудить с владельцем (scope creep!)
```

---

## Шаблоны коммуникации

### Начало работы
```
Начинаю работу над: [название задачи]

Критерии готовности:
- [критерий 1]
- [критерий 2]

План работы:
1. [первый шаг]
2. [второй шаг]
...

Есть вопросы перед стартом? Если нет, начинаю.
```

### Сообщение о блокере
```
Блокер: [название задачи]

Проблема: [описание]

Что попробовал:
1. [подход 1] -> [результат]
2. [подход 2] -> [результат]

Варианты:
A) [вариант и последствия]
B) [вариант и последствия]

Моя рекомендация: [A/B] потому что [причина]
```

### Задача завершена
```
Задача завершена: [название]

Критерии готовности:
[x] [критерий 1]
[x] [критерий 2]

Что сделано:
- [краткий список]

Проверка scope creep:
- Все изменения в рамках декомпозиции? (да/нет)

## Сценарии тестирования

### Сценарий 1: [название]
- URL: /path
- Шаги: ...
- Ожидаемый результат: ...

Файлы: [список созданных/изменённых]

Готов к приёмке.
```

---

## Приоритеты при конфликтах

1. **Безопасность** > всё остальное
2. **Критерии готовности** > nice-to-have
3. **Существующие паттерны** > новые решения
4. **Простота** > гибкость
5. **Работающий код** > идеальный код

---

## Антипаттерны

### НЕ делать:

- Начинать новую задачу без завершения текущей
- Добавлять фичи "по пути" без обсуждения
- Менять архитектуру без спроса
- Удалять код/данные без бэкапа
- Откладывать сообщение о блокере
- Пропускать тесты после приёмки
- **Коммитить сразу после "закрываем"** — сначала итоги, приёмка, pre-commit
- **Пропускать lint/type-check/build/test** перед коммитом
- **Пропускать приёмку** — даже если владелец торопит
- **Забывать рефлексию** — это не формальность

### ВСЕГДА делать:
- Держать фокус на ОДНОЙ задаче
- Отмечать прогресс в реальном времени
- Проверять UI в браузере
- Сообщать о проблемах рано
- Писать тесты после приёмки
- **Запускать lint + type-check + build + test** перед каждым коммитом
- **Показывать итоги + сценарии** перед закрытием задачи
- **Проходить чек-лист закрытия**
- **Распознавать триггеры** — "закрываем" != "коммить немедленно"

---

## Мультиагентная система

### Архитектура

Оркестратор-центричная модель. Claude (оркестратор) ведёт процесс и вызывает агентов.

```
                  +-------------------+
                  |   @orchestrator   |  <- Claude (лид)
                  +--------+----------+
                           | координирует
       +-------------------+-------------------+
       v                   v                   v
  @developer          @designer           @auditor
  (код)               (UI/UX)             (проверка)
       |                   |                   |
       +-------------------+-------------------+
                           v
                       @tester
                       (тесты)
                           |
                       @documentor
                       (документация)
```

### Роли

| Агент | Когда вызывать | Что делает | Модель |
|-------|---------------|------------|--------|
| **@developer** | Реализация задач из декомпозиции | Пишет код, следует паттернам | opus |
| **@designer** | Новые страницы, UI-паттерны, UX-flow | Проектирует layout, компоненты | opus |
| **@auditor** | После разработки (перед приёмкой) | Безопасность, качество, performance | sonnet |
| **@tester** | После приёмки владельцем | Unit + E2E тесты | sonnet |
| **@documentor** | Изменения в API/БД/UI | Обновляет документацию | sonnet |

### Workflow с агентами

```
Фаза 1  ПЛАНИРОВАНИЕ  -> оркестратор + владелец. Команда: /task
Фаза 2  РАЗРАБОТКА     -> @developer (или оркестратор для мелких задач)
                        -> @designer (опционально, для нового UI/UX)
Фаза 3  АУДИТ          -> @auditor (или оркестратор + lint/type-check/build/test)
Фаза 4  ПРИЁМКА        -> оркестратор готовит, владелец проверяет
Фаза 5  ТЕСТЫ          -> @tester (после приёмки)
Фаза 6  ЗАКРЫТИЕ       -> оркестратор. Команда: /done
                        -> @documentor (если API/БД/UI изменились)
```

**Ключевой принцип**: агенты — инструмент, gates — обязательны.

---

## Технические принципы

### Код
- Следовать существующим паттернам кодовой базы
- Использовать TypeScript strict mode
- Предпочитать редактирование существующих файлов созданию новых

<!-- Добавь стеко-специфичные принципы: ORM, UI-фреймворк, архитектурные паттерны -->

### UI
- Проверять в браузере
- Тестировать responsive (desktop + mobile)

### Тесты
- Unit-тесты для логики
- E2E-тесты для пользовательских flow
- Coverage > 80%

<!-- Добавь стеко-специфичные инструменты тестирования -->

---

## Архитектура инструкций

### Принцип разделения

```
MEMORY.md     = "ЧТО ПОМНИТЬ" (оперативная память между сессиями)
CLAUDE.md     = "ЧТО делать" (правила, точка входа)
DECISIONS.md  = "КАК делать" (процесс, workflow)
GUIDELINES.md = "КАК писать код" (паттерны, conventions)
```

### Навигация

```
Новая сессия AI
      |
  MEMORY.md (автозагрузка)
      |
  CLAUDE.md (точка входа)
      |
  DECISIONS.md (если нужен workflow)
      |
  GUIDELINES.md (если нужны паттерны)
```

---

## References

<!-- Обнови пути под свой проект -->

- **CLAUDE.md** (root) — точка входа для AI
- **DECISIONS.md** — этот файл (workflow)
- **Skills**: `/task` (открыть задачу), `/done` (закрыть задачу)
