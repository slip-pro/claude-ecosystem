# AI Decision Framework

Инструкции для автономной работы над проектом.
Адаптируй для своего проекта: замени [PROJECT], добавь стеко-специфичные команды.

---

## Философия

### Goal-First
Мы достигаем **ЦЕЛЕЙ**, не выполняем задачи.
- Цель = измеримый результат для пользователя
- Фича = способ достижения цели
- Задача = шаг реализации фичи

### One Goal at a Time
- Работаем над **ОДНОЙ** целью пока не достигнем
- Новые идеи добавляем в очередь, не переключаемся
- Исключение: критические баги в production

### Autonomy with Boundaries
- AI принимает решения в рамках текущей цели
- Выходы за рамки требуют подтверждения владельца

### Quality > Speed
- При проблеме: СТОП -> читаем правила -> планируем -> делаем правильно с первого раза
- Не торопимся

---

## Workflow спринта

### Обязательные gates (КРИТИЧНО)

Gates — шаги, которые НЕЛЬЗЯ пропустить ни при каких обстоятельствах.
Агенты — инструмент. Gates обязательны независимо от того, кто выполняет работу.

```
GATE 1: ПЛАНИРОВАНИЕ — согласовано с владельцем (цель + декомпозиция)
GATE 2: КАЧЕСТВО     — lint + type-check + build проходят (перед приёмкой)
GATE 3: ПРИЁМКА      — владелец видит итоги + сценарии и ЯВНО подтверждает
GATE 4: PRE-COMMIT   — lint + type-check + build + test (перед коммитом)
GATE 5: РЕФЛЕКСИЯ    — чек-лист закрытия пройден, документация обновлена
```

**Если gate не пройден — дальше двигаться НЕЛЬЗЯ.**

### Распознавание триггеров (КРИТИЧНО)

| Фраза пользователя | Что это значит | Что AI делает |
|---|---|---|
| "закрываем", "коммить", "готово", "финализируем" | Триггер **последовательности закрытия** | НЕ коммитить. Перейти к фазе 4 (Приёмка) |
| "ОК", "принято", "всё ок" (после итогов) | Приёмка пройдена | Перейти к Pre-commit -> Commit -> Рефлексия |
| "пуш", "push", "запушь" | Команда на push | Push (коммит уже должен быть создан) |

**ПРАВИЛО**: AI НИКОГДА не создаёт commit сразу после "закрываем".
Между "закрываем" и commit всегда: итоги -> сценарии -> приёмка -> pre-commit.

---

### 0. Подготовка (PRE-GATE)

**Команды**: `/plan` — начальное планирование, `/pbr` — груминг бэклога.

**Когда запускать**:
- `/plan` — новый проект ИЛИ очередь целей пуста
- `/pbr` — между спринтами, для актуализации бэклога

**Результат**: Наполненные GOALS.md и BACKLOG.md, готовые к `/sprint`.

---

### 1. Планирование (GATE 1)

**Команда**: `/sprint` — автоматизирует эту фазу.

**Что делаем вместе с владельцем**:
1. Выбираем следующую цель из очереди (или формулируем новую)
2. Уточняем критерий успеха — что значит "цель достигнута"
3. Обсуждаем фичи — какие нужны для достижения цели
4. **Согласовываем декомпозицию** — на какие задачи разбиваем спринт
5. Обсуждаем подход — как реализовать

**ВАЖНО**: Декомпозиция спринта на задачи требует согласования с владельцем!
AI не должен самостоятельно разбивать цель на задачи — это делаем вместе.

**Результат**: Согласованный план И декомпозиция, старт автономной работы.

---

### 1a. Ревью плана аудитором (опционально)

**Когда**: сложные задачи (> 3 файлов, архитектурные изменения, security-related)

После согласования плана с владельцем (GATE 1), запустить @auditor на проверку плана.
Если аудитор находит проблемы — скорректировать план до начала разработки.

---

### 2. Разработка

**Кто выполняет** — оркестратор решает:

| Ситуация | Исполнитель |
|----------|-------------|
| Новые компоненты, страницы, фичи (> 100 строк) | `@developer` |
| Рефакторинг, фиксы багов, мелкие правки (< 100 строк) | Оркестратор напрямую |
| Новый layout, UI-паттерн, UX-flow | `@designer` -> `@developer` |
| Конфигурационные файлы, документация | Оркестратор напрямую |

**Принципы**:
- Работаю последовательно по декомпозиции
- Отмечаю выполненное `[x]` в чек-листе
- Решаю технические вопросы самостоятельно

**Когда НЕ спрашивать владельца**:
- Выбор библиотеки (если уже есть в проекте)
- Структура компонентов (следую существующим паттернам)
- Мелкие рефакторинги в рамках задачи
- Исправление lint/type ошибок

**Когда СПРАШИВАТЬ владельца**:
- Архитектурные решения (новый паттерн, новая зависимость)
- Изменение scope цели (нужно больше/меньше фич)
- Критический блокер (>2 часов без прогресса)
- Неоднозначные UX/UI решения
- Любые удаления/миграции данных

---

### 2a. Параллельная работа (git worktrees)

Для параллельной работы над несколькими задачами используем git worktrees.
Каждый worktree — отдельная рабочая директория с собственной веткой и сессией Claude Code.

**Когда использовать:**
- Параллельная работа над несколькими фичами
- Работа над фичей пока ждём приёмку другой
- Hotfix в master пока идёт разработка в feature-ветке

**Правила:**
- Каждый worktree = своя сессия Claude Code (отдельный терминал)
- НЕ работать в одном worktree из двух сессий одновременно
- После merge PR — удалять worktree

---

### 3. Аудит (GATE 2)

**Триггер**: Разработка завершена (до приёмки пользователем)

#### Минимальные проверки (ОБЯЗАТЕЛЬНЫ всегда):

Запусти проверки качества проекта. Команды — из CLAUDE.md или package.json:
1. **Lint** — линтер
2. **Type-check** — проверка типов
3. **Build** — production сборка

**Если не проходит — НЕ переходить к приёмке. Исправить сначала.**

#### Полный аудит через @auditor (рекомендуется при):
- Новый код > 100 строк
- Изменения в API / auth / data layer
- Новые зависимости
- Изменения в security-related файлах

#### Тест-кейсы для ручной проверки (ОБЯЗАТЕЛЬНО после GATE 2)

Как только проверки прошли — AI **НЕМЕДЛЕННО** показывает тест-кейсы:

```markdown
## Тест-кейсы G-XXX

### TC-1: [Название сценария]
- **URL**: /path/to/page
- **Предусловия**: [если есть]
- **Шаги**:
  1. Открыть [URL]
  2. Кликнуть / ввести / выбрать [действие]
  3. Проверить [что]
- **Ожидаемый результат**: [что должно произойти]

### Edge cases
- [ ] Пустые поля / пустой список
- [ ] Длинный текст / спецсимволы
- [ ] Некорректный ввод
```

---

### 4. Приёмка (GATE 3)

**Триггеры**: Аудит пройден + пользователь сказал "закрываем" / "готово"

**Обязательная последовательность**:
1. **Показать итоги** по шаблону (см. Шаблоны коммуникации)
2. **Проверка scope creep**: есть ли изменения НЕ из декомпозиции?
3. **Ждать явного подтверждения** — "ОК" / "принято"
4. **Если ОК** -> тесты -> закрытие
5. **Если НЕ ОК** -> возврат к разработке

**ВАЖНО**: Приёмка происходит по ЦЕЛИ, не по отдельным фичам.

---

### 5. Тесты (@tester — после приёмки)

**Триггер**: Приёмка пройдена

@tester пишет unit + integration + E2E тесты. Target coverage: > 80%.

**ВАЖНО**: Тесты пишутся ПОСЛЕ приёмки всей цели, не после каждой фичи.

**Когда можно пропустить**:
- Спринт не создал новой функциональности (только рефакторинг/фиксы)
- Тесты уже были частью задачи спринта

---

### 6. Закрытие (GATE 4 + GATE 5)

**Шаги выполняются СТРОГО последовательно. Пропускать НЕЛЬЗЯ.**

#### 6a. Pre-commit проверки (GATE 4)

Запусти все проверки качества (lint, type-check, build, test).
**Если хотя бы одна не прошла — НЕ коммитить.**

#### 6b. Commit

- `git diff --stat` для понимания изменений
- Осмысленное сообщение коммита
- Исключить: .env, credentials, .claude/settings.local.json

#### 6c. Обновление tracking docs

- Отметить цель как достигнутую
- Переместить в "Достигнутые цели"
- Отметить завершённые фичи в бэклоге

#### 6d. Чек-лист документации (GATE 5)

Адаптируй под проект:

```
[ ] Component registry  — новые компоненты зарегистрированы?
[ ] API docs            — новые endpoints документированы?
[ ] Architecture docs   — архитектурные решения зафиксированы?
[ ] Backlog             — фичи/TD отмечены?
[ ] Test scenarios      — сценарии добавлены/актуализированы?
[ ] @documentor         — нужна проверка консистентности?
```

#### 6e. Рефлексия

5 вопросов (обязательно):
1. Что нового узнали в этом спринте?
2. Какие вопросы задавал пользователь, которых нет в инструкциях?
3. Что было сложно / неочевидно?
4. Какие шаги workflow были нарушены и почему?
5. Что нужно добавить/изменить в инструкциях?

#### 6f. Применить рефлексию (ОБЯЗАТЕЛЬНО)

**Рефлексия без действий — бесполезна.** AI ОБЯЗАН сразу после рефлексии применить выводы:

1. **Обновить инструкции** — если обнаружены пробелы
2. **Добавить tech debt** — если обнаружены проблемы качества
3. **Обновить notes** — записать паттерны и проблемы

**Чек-лист:**
```
[ ] Каждый пункт рефлексии -> конкретное действие (обновить файл / добавить TD / НЕ ТРЕБУЕТСЯ)
[ ] Все файлы обновлены в этой же сессии (не "потом")
```

#### 6g. Финальный коммит документации

Если шаги 6c-6f привели к изменениям — создать отдельный коммит для документации.

---

## Принятие решений

### Чек-лист: Нужно ли спрашивать?

```
[ ] Решение влияет только на текущую фичу?
    -> Нет: СПРАШИВАТЬ
[ ] Есть существующий паттерн в проекте?
    -> Да: Следовать паттерну, НЕ спрашивать
[ ] Решение обратимо за <30 минут?
    -> Да: Принять и двигаться дальше
[ ] Затрагивает деньги/безопасность/данные?
    -> Да: ОБЯЗАТЕЛЬНО СПРАШИВАТЬ
[ ] Не уверен?
    -> СПРАШИВАТЬ
```

### Чек-лист: Как обрабатывать блокер

```
1. [ ] Попробовал 2+ разных подхода?
2. [ ] Проверил документацию / issues?
3. [ ] Потратил >1 час на проблему?
4. [ ] Могу чётко сформулировать проблему?

Если все ДА -> Сообщить владельцу:
- Что пытался сделать
- Что попробовал
- Где застрял
- Какие варианты вижу

Если НЕ все ДА -> Продолжить попытки
```

### Чек-лист: Добавлять ли фичу в scope

```
[ ] Фича НЕОБХОДИМА для критерия успеха?
    -> Да: Добавить в декомпозицию
    -> Нет: В backlog для будущей цели
[ ] Это "nice to have"?
    -> Да: В backlog, НЕ в текущий scope
[ ] Фича займёт >2 часов?
    -> Да: Обсудить с владельцем (scope creep!)
```

---

## Шаблоны коммуникации

### Начало работы над целью
```
Начинаю работу над целью G-XXX: [название]

Критерий успеха:
- [критерий 1]
- [критерий 2]

План работы:
1. [первый шаг]
2. [второй шаг]
...

Есть вопросы перед стартом? Если нет, начинаю.
```

### Сообщение о блокере
```
Блокер при работе над G-XXX

Проблема: [описание]

Что попробовал:
1. [подход 1] -> [результат]
2. [подход 2] -> [результат]

Варианты:
A) [вариант и последствия]
B) [вариант и последствия]

Моя рекомендация: [A/B] потому что [причина]
```

### Цель достигнута
```
Цель G-XXX достигнута

Критерий успеха:
[x] [критерий 1]
[x] [критерий 2]

Что сделано:
- [краткий список]

Сценарии для проверки:
1. Открыть [URL] -> [ожидаемый результат]
2. ...

Файлы: [список созданных/изменённых]

Готов к приёмке.
```

---

## Приоритеты при конфликтах

1. **Безопасность** > всё остальное
2. **Критерий успеха** > nice-to-have
3. **Существующие паттерны** > новые решения
4. **Простота** > гибкость
5. **Работающий код** > идеальный код

---

## Антипаттерны

### НЕ делать:
- Начинать новую цель без завершения текущей
- Добавлять фичи "по пути" без обсуждения
- Менять архитектуру без спроса
- Удалять код/данные без бэкапа
- Откладывать сообщение о блокере
- Пропускать тесты после приёмки
- **Коммитить сразу после "закрываем"** — сначала итоги, приёмка, pre-commit
- **Пропускать lint/type-check/build** перед коммитом
- **Пропускать приёмку** — даже если пользователь торопит
- **Забывать рефлексию** — это не формальность
- **Писать рефлексию без действий** — каждый вывод -> конкретное изменение

### ВСЕГДА делать:
- Читать goals перед началом сессии
- Держать фокус на ОДНОЙ цели
- Отмечать прогресс в реальном времени
- Проверять UI в браузере
- Сообщать о проблемах рано
- Писать тесты после приёмки
- **Запускать lint + type-check + build** перед каждым коммитом
- **Показывать итоги + сценарии** перед закрытием спринта
- **Проходить чек-лист закрытия**
- **Распознавать триггеры** — "закрываем" != "коммить немедленно"

---

## Мультиагентная система

### Архитектура

Оркестратор-центричная модель. Claude (оркестратор) ведёт процесс и вызывает агентов по мере необходимости.

```
                  +-------------------+
                  |   @orchestrator   |  <- Claude (лид)
                  +--------+----------+
                           | координирует
       +-------------------+-------------------+
       v                   v                   v
  @developer          @designer           @auditor
  (код)               (UI/UX)             (проверка)
       |                   |                   |
       +-------------------+-------------------+
                           v
                       @tester
                       (тесты)
                           |
                       @documentor
                       (документация)
```

### Роли

| Агент | Когда вызывать | Что делает |
|-------|---------------|------------|
| **@developer** | Новые фичи, компоненты (> 100 строк) | Пишет код, следует паттернам |
| **@designer** | Новые страницы с уникальным layout, UI-паттерны | Проектирует layout, компоненты |
| **@auditor** | Новый код > 100 строк, API/auth/data изменения | Безопасность, качество, performance |
| **@tester** | После приёмки ЦЕЛИ пользователем | Unit + integration + E2E тесты |
| **@documentor** | Изменения в API/БД/UI + конец спринта | Обновляет документацию |

**Оркестратор работает напрямую** для:
- Фиксы багов, мелкие правки (< 100 строк)
- Рефакторинг существующего кода
- Конфигурационные файлы, документация
- lint/type-check/build проверки

### Workflow с агентами

```
Фаза 1  ПЛАНИРОВАНИЕ  -> оркестратор + владелец
Фаза 2  РАЗРАБОТКА     -> @developer / @designer / оркестратор
Фаза 3  АУДИТ          -> @auditor / оркестратор + lint/type/build
Фаза 4  ПРИЁМКА        -> оркестратор готовит, владелец проверяет
Фаза 5  ТЕСТЫ          -> @tester
Фаза 6  ЗАКРЫТИЕ       -> оркестратор + @documentor
```

**Ключевой принцип**: агенты — инструмент, gates — обязательны.

---

## Обновление файлов

### Goals file
- При старте: заполнить декомпозицию
- В процессе: отмечать выполненное, вести дневник
- При блокере: добавить в секцию "Блокеры"
- При достижении: переместить в "Достигнутые"
- **НЕ менять без владельца**: очередь целей, критерии успеха

### Notes (docs/notes/<goal-id>.md)
- Создавать при старте новой цели
- Обновлять: ключевые решения, проблемы, паттерны
- Цель: контекст при возврате к этой области

### Backlog file
- При детализации фичи для текущей цели
- При обнаружении нового техдолга
- **НЕ менять без владельца**: приоритеты целей, удаление фич

---

## Архитектура инструкций

### Принцип разделения

```
MEMORY.md     = "ЧТО ПОМНИТЬ" (оперативная память между сессиями)
CLAUDE.md     = "ЧТО делать" (правила, точка входа)
DECISIONS.md  = "КАК делать" (процесс, workflow)
GUIDELINES.md = "КАК писать код" (паттерны, conventions)
```

### Файлы и их роли

| Файл | Роль | Что хранить | Коммитится? |
|------|------|-------------|-------------|
| `MEMORY.md` | Указатель + текущий статус | Ссылки на файлы, статус | Нет (локальный) |
| `CLAUDE.md` | Точка входа | Critical rules, quick ref | Да |
| `DECISIONS.md` | Полный workflow | Фазы, gates, агенты | Да |
| `GUIDELINES.md` | Code patterns | Stack-specific patterns | Да |
| `docs/notes/*.md` | Контекст задач | Решения спринта | Да |

### Навигация

```
Новая сессия AI
      |
  MEMORY.md (автозагрузка)
      |
  CLAUDE.md (точка входа)
      |
  DECISIONS.md (если нужен workflow)
      |
  GUIDELINES.md (если нужны паттерны)
```
